services:
  db:
    image: postgres:${PYTEST_PG_VERSION:-9.3}-alpine
    networks:
      - dbnet
    environment:
      POSTGRES_DB: odoodb
      POSTGRES_PASSWORD: odoo
      POSTGRES_USER: odoo
      POSTGRES_INITDB_ARGS: --locale=C --encoding=UTF8
    hostname: odoo-db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U odoo -d odoodb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  odoo:
    build:
      context: .
      additional_contexts:
        deps: ./v${PYTEST_ODOO_VERSION:-6.0}/deps
        addons: ./v${PYTEST_ODOO_VERSION:-6.0}/addons
        private: ./v${PYTEST_ODOO_VERSION:-6.0}/private
    depends_on:
      db:
        condition: service_healthy
    ports:
      - '8080:8080'
      - '8069:8069'
    networks:
      frontend:
        ipv4_address: 10.99.2.38
      dbnet:
    environment:
      OCONF__options__log_level: debug
      OCONF__options__db_filter: odoodb$
      OCONF__options__db_user: odoo
      OCONF__options__db_password: odoo
      OCONF__options__db_host: odoo-db
      OCONF__options__db_name: odoodb
      OCONF__options__proxy_mode: false
      OCONF__options__workers: 0
    hostname: odoo


networks:
  frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 10.99.0.0/16
  dbnet:
